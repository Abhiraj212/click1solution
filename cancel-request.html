<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cancel your request or registration with Click1Solutions.">
    <meta name="theme-color" content="#6366f1">
    <meta name="robots" content="noindex">
    <link rel="manifest" href="manifest.json">
    <title>Cancel Request | Click1Solutions Pvt. Ltd.</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .cancel-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 100px var(--space-lg) var(--space-lg);
            background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
        }
        
        .cancel-card {
            width: 100%;
            max-width: 500px;
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-xl);
        }
        
        .cancel-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }
        
        .cancel-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
        }
        
        .cancel-icon svg {
            width: 40px;
            height: 40px;
            color: var(--white);
        }
        
        .cancel-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: var(--space-sm);
        }
        
        .cancel-header p {
            color: var(--gray);
            font-size: 0.9375rem;
        }
        
        .info-box {
            background: rgba(99, 102, 241, 0.08);
            border-left: 4px solid var(--primary);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-lg);
        }
        
        .info-box p {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin: 0;
        }
        
        .confirmation-step {
            display: none;
            text-align: center;
            padding: var(--space-xl) 0;
        }
        
        .confirmation-step.active {
            display: block;
        }
        
        .confirmation-step h3 {
            font-size: 1.25rem;
            color: var(--dark);
            margin-bottom: var(--space-md);
        }
        
        .confirmation-step p {
            color: var(--gray-dark);
            margin-bottom: var(--space-xl);
        }
        
        .warning-icon {
            width: 60px;
            height: 60px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
        }
        
        .warning-icon svg {
            width: 28px;
            height: 28px;
            color: var(--danger);
        }
        
        .request-details {
            background: var(--light);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            text-align: left;
        }
        
        .request-details h4 {
            font-size: 0.875rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-md);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--gray);
            font-size: 0.875rem;
        }
        
        .detail-value {
            color: var(--dark);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: var(--white);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            color: var(--success);
        }
        
        .back-link {
            text-align: center;
            margin-top: var(--space-xl);
        }
        
        .back-link a {
            color: var(--primary);
            font-weight: 500;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="container header-inner">
            <a href="index.html" class="logo">
                <div class="logo-icon">C1</div>
                <span>Click1Solutions</span>
            </a>
            
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="services.html" class="nav-link">Services</a></li>
                    <li><a href="staff-register.html" class="nav-link">Register</a></li>
                    <li><a href="admin-login.html" class="nav-link">Admin</a></li>
                </ul>
            </nav>
            
            <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>
    
    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobileNav">
        <ul class="mobile-nav-list">
            <li class="mobile-nav-item"><a href="index.html" class="mobile-nav-link">Home</a></li>
            <li class="mobile-nav-item"><a href="services.html" class="mobile-nav-link">Services</a></li>
            <li class="mobile-nav-item"><a href="staff-register.html" class="mobile-nav-link">Register</a></li>
            <li class="mobile-nav-item"><a href="admin-login.html" class="mobile-nav-link">Admin</a></li>
        </ul>
    </nav>
    
    <!-- Cancel Section -->
    <section class="cancel-section">
        <div class="cancel-card">
            <!-- Step 1: Enter Request ID -->
            <div id="step1" class="step-content">
                <div class="cancel-header">
                    <div class="cancel-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </div>
                    <h1>Cancel Your Request</h1>
                    <p>Enter your request ID to cancel your registration or service request.</p>
                </div>
                
                <div class="info-box">
                    <p><strong>Note:</strong> Your request ID was provided when you submitted your registration. Check your confirmation message.</p>
                </div>
                
                <form id="cancelForm">
                    <div class="form-group">
                        <label for="requestId" class="form-label required">Request ID</label>
                        <input 
                            type="text" 
                            id="requestId" 
                            class="form-input" 
                            placeholder="e.g., req_1234567890"
                            required
                            autocomplete="off"
                        >
                        <div class="form-error" id="requestIdError"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-danger btn-block btn-lg">
                        Find My Request
                    </button>
                </form>
                
                <div class="back-link">
                    <a href="index.html">‚Üê Back to Home</a>
                </div>
            </div>
            
            <!-- Step 2: First Confirmation -->
            <div id="step2" class="confirmation-step">
                <div class="warning-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <h3>Are you sure?</h3>
                <p>You are about to cancel your request. This action cannot be undone.</p>
                
                <div class="request-details" id="requestDetails1">
                    <!-- Dynamic content -->
                </div>
                
                <div style="display: flex; gap: var(--space-md);">
                    <button class="btn btn-outline" onclick="goBack()" style="flex: 1;">No, Go Back</button>
                    <button class="btn btn-danger" onclick="proceedToStep3()" style="flex: 1;">Yes, Cancel</button>
                </div>
            </div>
            
            <!-- Step 3: Final Confirmation -->
            <div id="step3" class="confirmation-step">
                <div class="warning-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <h3>Final Confirmation</h3>
                <p><strong>This is your last chance to keep your request.</strong><br>Once deleted, all your data will be permanently removed from our system.</p>
                
                <div class="request-details" id="requestDetails2">
                    <!-- Dynamic content -->
                </div>
                
                <div style="display: flex; gap: var(--space-md);">
                    <button class="btn btn-outline" onclick="goBackToStep2()" style="flex: 1;">Keep My Request</button>
                    <button class="btn btn-danger" onclick="confirmCancel()" style="flex: 1;">Permanently Delete</button>
                </div>
            </div>
            
            <!-- Step 4: Success -->
            <div id="step4" class="confirmation-step">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h3>Request Cancelled</h3>
                <p>Your request has been successfully cancelled and all data has been removed from our system.</p>
                
                <a href="index.html" class="btn btn-primary btn-block btn-lg" style="margin-top: var(--space-xl);">
                    Return to Home
                </a>
            </div>
            
            <!-- Not Found -->
            <div id="notFound" class="confirmation-step">
                <div class="warning-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                </div>
                <h3>Request Not Found</h3>
                <p>We couldn't find a request with that ID. Please check and try again.</p>
                
                <button class="btn btn-primary btn-block btn-lg" onclick="resetForm()" style="margin-top: var(--space-xl);">
                    Try Again
                </button>
            </div>
        </div>
    </section>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>
    
    <script src="security.js"></script>
    <script src="script.js"></script>
    <script>
        let currentRequest = null;
        let currentRequestId = null;
        
        // Form submission
        document.getElementById('cancelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('requestId').value.trim();
            document.getElementById('requestIdError').textContent = '';
            
            if (!requestId) {
                document.getElementById('requestIdError').textContent = 'Please enter your request ID';
                return;
            }
            
            showLoading(true);
            
            try {
                // Search in staff requests
                const staffRequests = await SecurityModule.secureRetrieve('staffRequests') || [];
                const request = staffRequests.find(r => r.id === requestId);
                
                if (request) {
                    currentRequest = request;
                    currentRequestId = requestId;
                    showRequestDetails(request);
                    showStep('step2');
                } else {
                    showStep('notFound');
                }
            } catch (error) {
                console.error('Error finding request:', error);
                showToast('Error searching for request', 'error');
            }
            
            showLoading(false);
        });
        
        function showRequestDetails(request) {
            const detailsHtml = `
                <h4>Request Details</h4>
                <div class="detail-row">
                    <span class="detail-label">Name</span>
                    <span class="detail-value">${escapeHtml(request.fullName)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Service</span>
                    <span class="detail-value">${formatService(request.serviceCategory, request.otherService)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" style="text-transform: capitalize;">${request.status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Submitted</span>
                    <span class="detail-value">${formatDate(request.submittedAt)}</span>
                </div>
            `;
            
            document.getElementById('requestDetails1').innerHTML = detailsHtml;
            document.getElementById('requestDetails2').innerHTML = detailsHtml;
        }
        
        function proceedToStep3() {
            showStep('step3');
        }
        
        function goBack() {
            currentRequest = null;
            currentRequestId = null;
            document.getElementById('requestId').value = '';
            showStep('step1');
        }
        
        function goBackToStep2() {
            showStep('step2');
        }
        
        async function confirmCancel() {
            if (!currentRequestId) return;
            
            showLoading(true);
            
            try {
                // Get current requests
                let staffRequests = await SecurityModule.secureRetrieve('staffRequests') || [];
                
                // Remove the request
                const initialLength = staffRequests.length;
                staffRequests = staffRequests.filter(r => r.id !== currentRequestId);
                
                if (staffRequests.length < initialLength) {
                    // Save updated list
                    await SecurityModule.secureStore('staffRequests', staffRequests);
                    
                    // Show success
                    showStep('step4');
                } else {
                    showToast('Request not found', 'error');
                    showStep('step1');
                }
            } catch (error) {
                console.error('Error cancelling request:', error);
                showToast('Error cancelling request', 'error');
            }
            
            showLoading(false);
        }
        
        function resetForm() {
            document.getElementById('requestId').value = '';
            showStep('step1');
        }
        
        function showStep(stepId) {
            document.querySelectorAll('.step-content, .confirmation-step').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            
            const step = document.getElementById(stepId);
            if (step) {
                step.style.display = 'block';
                if (step.classList.contains('confirmation-step')) {
                    step.classList.add('active');
                }
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatService(category, other) {
            const categories = {
                'construction': 'Construction',
                'food': 'Food Services',
                'travel': 'Travel & Tourism',
                'gst': 'GST Services',
                'marketing': 'Digital Marketing',
                'it': 'IT Solutions',
                'other': other || 'Other'
            };
            return categories[category] || category;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
